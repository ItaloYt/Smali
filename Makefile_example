# see the Makefile_example at repository root

res_dir = res
class_dir = classes
smali_dir = smali

src = $(wildcard src/*.java)
class_files = $(src:src/%.java=$(class_dir)/%.class)
classes = $(class_files:$(class_dir)/%=%)

manifest = $(res_dir)/manifest.mf

out_dir = out

# lib/library is the jar containing executable code
lib_out = $(out_dir)/lib.jar
dex_out = $(out_dir)/class.dex

sdex_out = $(out_dir)/sclass.dex

# Smali Lib(SLib) is the jar containing executable code
# by compiling smali
slib_out = $(out_dir)/slib.jar

# Object Smali Dir(OSmaliDir) is a directory that contains
# timestamp files(empty files) so we dont need to recompile
# files that weren't changed
osmali_dir = $(smali_dir)/object
smali_src = $(wildcard $(smali_dir)/*.smali)
smali_obj = $(smali_src:$(smali_dir)/%.smali=$(osmali_dir)/%.smali_object)

java_target = 8

javac = javac
jar = jar
dx = d2j-jar2dex
jr = d2j-dex2jar
baksmali = d2j-baksmali
smali = d2j-smali
rm = rm
rm_dir_flags = -rf

.PHONY: init compile decompile pack_jar jar_to_dex
.PHONY: disassembly_dex dex_to_jar
init:
	# creates all directories needed
	mkdir $(res_dir) $(class_dir) $(smali_dir) $(osmali_dir) $(out_dir)

compile: $(class_files) pack_jar

decompile: jar_to_dex disassembly_dex

recompile: $(smali_obj) dex_to_jar

clear-all: cclear dclear rclear

# Compile Clear(CClear): clear all files generated by 
# jar and javac
cclear:
	$(rm) $(class_files) $(lib_out)

# Decompile Clear(DClear): clear all .dex files and .smali
# files generated by baksmali
dclear:
	$(rm) $(dex_out) $(smali_dir) $(rm_dir_flags)

# Recompile Clear(RClear): clear all .jar and .dez files
# generated from smali
rclear:
	$(rm) $(sdex_out) $(slib_out)

classes/%.class: src/%.java
	$(javac) -source $(java_target) -target $(java_target) -cp $(class_dir) -sourcepath src/ -d $(class_dir) $< 

pack_jar:
	$(jar) -c -f $(lib_out) -m $(manifest) -C $(class_dir) .

jar_to_dex:
	$(dx) $(lib_out) -o $(dex_out) --force

disassembly_dex:
	$(baksmali) $(dex_out) -o $(smali_dir) --force

$(osmali_dir)/%.smali_object: $(smali_dir)/%.smali
	touch $@
	$(smali) $< -o $(sdex_out)

dex_to_jar:
	$(jr) $(sdex_out) -o $(slib_out) --force

# adds manifest to jar file
	$(jar) -u -f $(slib_out) -m $(manifest)
